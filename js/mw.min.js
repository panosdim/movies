(function(){"use strict";var btnClear=document.getElementById("btnClear");var btnLogin=document.getElementById("btnLogin");var btnLogout=document.getElementById("btnLogout");var btnRegister=document.getElementById("btnRegister");var btnSearch=document.getElementById("btnSearch");var btnSignUp=document.getElementById("btnSignUp");var btnUpdate=document.getElementById("btnUpdate");var frmLogin=document.getElementById("frmLogin");var frmRegister=document.getElementById("frmRegister");var inpSearch=document.getElementById("inpSearch");var logout=document.getElementById("logout");var lstMovies=document.getElementById("lstMovies");var lstResults=document.getElementById("lstResults");var mdlSignUp=document.getElementById("mdlSignUp");var ntfMdlMessage=document.getElementById("ntfMdlMessage");var ntfMessage=document.getElementById("ntfMessage");var sctResults=document.getElementById("sctResults");var sctMain=document.getElementById("sctMain");var sctNewReleases=document.getElementById("sctNewReleases");var signUp=document.getElementById("signUp");var welcome=document.getElementById("welcome");var ajax=new XMLHttpRequest;var msgTimeout;var user={};ajax.open("POST","php/session.php",true);ajax.send();ajax.onload=function(){if(this.status>=200&&this.status<400){user=JSON.parse(this.responseText);if(user.loggedIn){sctMain.style.display="";sctNewReleases.style.display="none";frmLogin.parentNode.style.display="none";logout.style.display="";signUp.style.display="none";welcome.innerText="Welcome "+user.email;welcome.style.display="";getWatchlist()}else{newReleases()}}else{displayMessage({status:"error",message:"Error contacting server."})}};new autoComplete({selector:inpSearch,source:function(term,response){var ajax=new XMLHttpRequest;ajax.open("POST","php/autocomplete.php",true);ajax.send(JSON.stringify(term));ajax.onload=function(){if(this.status>=200&&this.status<400){response(JSON.parse(this.responseText))}else{displayMessage({status:"error",message:"Error contacting server."})}}},onSelect:function(e,term){btnSearch.classList.add("is-loading");var query=term.replace(/\(.*\)$/,"");search(query)}});btnLogin.addEventListener("click",function(event){event.preventDefault();if(checkFormValidity(frmLogin)){ajax.open("POST","php/login.php",true);ajax.send(new FormData(frmLogin));ajax.onload=function(){var resp={};if(this.status>=200&&this.status<400){resp=JSON.parse(this.responseText);displayMessage(resp);if(resp.status==="info"){sctMain.style.display="";sctNewReleases.style.display="none";frmLogin.parentNode.style.display="none";logout.style.display="";signUp.style.display="none";welcome.innerText="Welcome "+resp.email;welcome.style.display="";getWatchlist()}}else{displayMessage({status:"error",message:"Error contacting server."})}}}});btnLogout.addEventListener("click",function(){ajax.open("POST","php/logout.php",true);ajax.send();ajax.onload=function(){if(this.status>=200&&this.status<400){displayMessage({status:"info",message:"Logged out successfully."});sctMain.style.display="none";sctNewReleases.style.display="";frmLogin.parentNode.style.display="";logout.style.display="none";signUp.style.display="";welcome.style.display="none";clearForm(frmLogin);newReleases()}else{displayMessage({status:"error",message:"Error contacting server."})}}});btnSignUp.addEventListener("click",function(){mdlSignUp.classList.add("is-active")});var modalButtons=document.querySelectorAll(".modal-card-head .delete, .modal-card-foot .button");var fnClose=function(){mdlSignUp.classList.remove("is-active")};for(var i=0;i<modalButtons.length;i++){modalButtons[i].addEventListener("click",fnClose)}btnRegister.removeEventListener("click",fnClose);btnRegister.addEventListener("click",function(event){event.preventDefault();ntfMdlMessage.style.display="none";if(checkFormValidity(frmRegister)){var password=document.getElementById("regPassword");var repeatPass=document.getElementById("regPasswordRepeat");if(password.value!==repeatPass.value){password.classList.remove("is-success");password.classList.add("is-danger");repeatPass.classList.remove("is-success");repeatPass.classList.add("is-danger");ntfMdlMessage.innerHTML="Passwords don't match";ntfMdlMessage.style.display=""}else{ajax.open("POST","php/register.php",true);ajax.send(new FormData(frmRegister));ajax.onload=function(){var resp={};if(this.status>=200&&this.status<400){resp=JSON.parse(this.responseText);if(resp.status==="success"){mdlSignUp.classList.remove("is-active");clearForm(frmRegister);displayMessage(resp)}else{ntfMdlMessage.innerHTML=resp.message;ntfMdlMessage.style.display=""}}else{displayMessage({status:"error",message:"Error contacting server."})}}}}});btnSearch.addEventListener("click",function(){btnSearch.classList.add("is-loading");if(document.querySelector("div.autocomplete-suggestion.selected")!=null){search(inpSearch.value.replace(/\(.*\)$/,""))}else{search(inpSearch.value)}});inpSearch.addEventListener("keypress",function(event){if(event.which==13||event.keyCode==13){if(document.querySelector("div.autocomplete-suggestion.selected")==null){document.querySelector("div.autocomplete-suggestions").style.display="none";btnSearch.classList.add("is-loading");search(inpSearch.value);return false}}return true});btnClear.addEventListener("click",function(){sctResults.style.display="none";lstMovies.style.display="";inpSearch.value=""});lstResults.addEventListener("click",function(e){if(e.target&&e.target.nodeName=="BUTTON"){var ajax=new XMLHttpRequest;var data=new FormData;data.append("title",e.target.dataset.title);data.append("overview",e.target.dataset.overview);data.append("image",e.target.dataset.image);ajax.open("POST","php/add.php",true);ajax.send(data);ajax.onload=function(){var resp={};if(this.status>=200&&this.status<400){resp=JSON.parse(this.responseText);if(resp.status=="success"){sctResults.style.display="none";lstMovies.style.display="";inpSearch.value="";getWatchlist()}displayMessage(resp)}else{displayMessage({status:"error",message:"Error contacting server."})}}}});lstMovies.addEventListener("click",function(e){if(e.target&&e.target.nodeName=="BUTTON"){var ajax=new XMLHttpRequest;var data=new FormData;data.append("id",e.target.dataset.id);ajax.open("POST","php/delete.php",true);ajax.send(data);ajax.onload=function(){var resp={};if(this.status>=200&&this.status<400){resp=JSON.parse(this.responseText);if(resp.status=="success"){getWatchlist()}displayMessage(resp)}else{displayMessage({status:"error",message:"Error contacting server."})}}}});btnUpdate.addEventListener("click",function(){displayMessage({status:"info",message:"Update of release dates started"});updateWatchlist()});function checkFormValidity(form){var i,valid,validInput,invalidInput;valid=form.checkValidity();if(valid){validInput=form.querySelectorAll("input:valid");for(i=0;i<validInput.length;i++){validInput[i].classList.remove("is-danger");validInput[i].classList.add("is-success")}}else{invalidInput=form.querySelectorAll("input:invalid");for(i=0;i<invalidInput.length;i++){invalidInput[i].classList.add("is-danger")}validInput=form.querySelectorAll("input:valid");for(i=0;i<validInput.length;i++){validInput[i].classList.remove("is-danger");validInput[i].classList.add("is-success")}}return valid}function clearForm(form,reset){reset=reset===undefined?false:reset;var i,invalidInput,validInput;invalidInput=form.querySelectorAll("input:invalid");for(i=0;i<invalidInput.length;i++){invalidInput[i].classList.remove("is-danger")}validInput=form.querySelectorAll("input:valid");for(i=0;i<validInput.length;i++){validInput[i].classList.remove("is-success")}if(reset){form.reset()}}function displayMessage(result){ntfMessage.innerHTML='<button class="delete"></button>';switch(result.status){case"info":ntfMessage.classList.add("is-primary");ntfMessage.classList.remove("is-success");ntfMessage.classList.remove("is-danger");break;case"success":ntfMessage.classList.add("is-success");ntfMessage.classList.remove("is-primary");ntfMessage.classList.remove("is-danger");break;case"error":ntfMessage.classList.add("is-danger");ntfMessage.classList.remove("is-success");ntfMessage.classList.remove("is-primary");break}ntfMessage.innerHTML=result.message;ntfMessage.style.display="";clearTimeout(msgTimeout);msgTimeout=setTimeout(function(){ntfMessage.style.display="none"},3e3)}function getWatchlist(){while(lstMovies.firstChild){lstMovies.removeChild(lstMovies.firstChild)}var ajax=new XMLHttpRequest;ajax.open("POST","php/get.php",true);ajax.send();ajax.onload=function(){var resp={};if(this.status>=200&&this.status<400){resp=JSON.parse(this.responseText);if(resp.status=="success"){var figure=HTMLElement;var content=HTMLElement;var media=HTMLElement;var img=HTMLElement;var title=HTMLElement;var mediaRight=HTMLElement;var button=HTMLElement;var box=HTMLElement;var grid=HTMLElement;var column=HTMLElement;var date="";var tag="";for(var i=0;i<resp.data.length;i++){grid=document.createElement("div");grid.classList.add("columns");column=document.createElement("div");column.classList.add("column","is-10","is-offset-1");box=document.createElement("div");box.classList.add("box");media=document.createElement("div");media.classList.add("media");figure=document.createElement("figure");figure.classList.add("media-left");img=document.createElement("img");img.setAttribute("src",resp.data[i].image);figure.appendChild(img);content=document.createElement("div");content.classList.add("media-content");title=document.createElement("div");title.classList.add("content");if(resp.data[i].release_date=="0000-00-00"){date="Not Defined";tag="is-danger"}else{var release_date=fecha.parse(resp.data[i].release_date,"YYYY-MM-DD");var today=new Date;date=fecha.format(release_date,"DD MMMM YYYY");if(release_date.getTime()<today.getTime()){tag="is-success"}else{tag="is-warning"}}title.innerHTML="<h1>"+resp.data[i].title+'</h1><span class="tag is-medium '+tag+'">'+date+"</span><br>"+resp.data[i].overview;content.appendChild(title);mediaRight=document.createElement("div");mediaRight.classList.add("media-right");button=document.createElement("button");button.classList.add("button","is-danger","delete");button.dataset.id=resp.data[i].id;mediaRight.appendChild(button);media.appendChild(figure);media.appendChild(content);media.appendChild(mediaRight);box.appendChild(media);column.appendChild(box);grid.insertBefore(column,grid.firstChild);if(tag=="is-danger"){lstMovies.appendChild(grid)}else{lstMovies.insertBefore(grid,lstMovies.firstChild)}}}else{displayMessage(resp)}}else{displayMessage({status:"error",message:"Error contacting server."})}}}function newReleases(){var ajax=new XMLHttpRequest;ajax.open("POST","php/newReleases.php",true);ajax.send();ajax.onload=function(){var resp={};if(this.status>=200&&this.status<400){resp=JSON.parse(this.responseText);var baseUrl=resp.conf.images.base_url+"w342";var cards=sctNewReleases.querySelectorAll(".card");for(var i=0;i<cards.length;i++){cards[i].getElementsByTagName("img")[0].setAttribute("src",baseUrl+resp.releases.results[i].poster_path);cards[i].getElementsByTagName("h2")[0].innerText=resp.releases.results[i].original_title;cards[i].getElementsByTagName("p")[0].innerText=resp.releases.results[i].overview}}else{displayMessage({status:"error",message:"Error contacting server."})}}}function search(query){while(lstResults.firstChild){lstResults.removeChild(lstResults.firstChild)}sctResults.style.display="";lstMovies.style.display="none";var ajax=new XMLHttpRequest;ajax.open("POST","php/search.php",true);ajax.send(JSON.stringify(query));ajax.onload=function(){var resp={};if(this.status>=200&&this.status<400){resp=JSON.parse(this.responseText);var baseUrl=resp.conf.images.base_url+"w92";var figure=HTMLElement;var content=HTMLElement;var media=HTMLElement;var img=HTMLElement;var title=HTMLElement;var mediaRight=HTMLElement;var button=HTMLElement;var box=HTMLElement;if(resp.movies.results.length==0){lstResults.innerHTML="<h2>Nothing found. Please search again.</h2>"}for(var i=0;i<resp.movies.results.length;i++){box=document.createElement("div");box.classList.add("box");media=document.createElement("div");media.classList.add("media");figure=document.createElement("figure");figure.classList.add("media-left");img=document.createElement("img");if(resp.movies.results[i].poster_path!==null){img.setAttribute("src",baseUrl+resp.movies.results[i].poster_path)}else{img.setAttribute("src","images/default-placeholder.png")}figure.appendChild(img);content=document.createElement("div");content.classList.add("media-content");title=document.createElement("div");title.classList.add("content");title.innerHTML="<h1>"+resp.movies.results[i].original_title+"</h1><br>"+resp.movies.results[i].overview;content.appendChild(title);mediaRight=document.createElement("div");mediaRight.classList.add("media-right");button=document.createElement("button");button.classList.add("button","is-success");button.innerText="Add to watchlist";button.dataset.image=img.getAttribute("src");button.dataset.title=resp.movies.results[i].original_title;button.dataset.overview=resp.movies.results[i].overview;mediaRight.appendChild(button);media.appendChild(figure);media.appendChild(content);media.appendChild(mediaRight);box.appendChild(media);lstResults.appendChild(box)}}else{displayMessage({status:"error",message:"Error contacting server."})}btnSearch.classList.remove("is-loading")}}function updateWatchlist(){var ajax=new XMLHttpRequest;ajax.open("POST","php/update.php",true);ajax.send();ajax.onload=function(){var resp={};if(this.status>=200&&this.status<400){resp=JSON.parse(this.responseText);displayMessage(resp);getWatchlist()}else{displayMessage({status:"error",message:"Error contacting server."})}}}})();